<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qwen Bbox OCR — PDF → vLLM распознавание</title>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        margin: 0;
        padding: 24px;
        color: #1a1a2e;
        background: #f0f4f8;
      }
      .container { max-width: 1200px; margin: 0 auto; }
      h1 {
        margin: 0 0 8px 0;
        font-size: 1.75rem;
        color: #0f172a;
      }
      .subtitle {
        color: #64748b;
        margin-bottom: 24px;
        font-size: 0.95rem;
      }
      .card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }
      .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 10px;
        padding: 32px 24px;
        text-align: center;
        background: #f8fafc;
        transition: border-color 0.2s, background 0.2s;
      }
      .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
      .upload-zone.has-file { border-color: #22c55e; background: #f0fdf4; }
      .upload-zone input[type="file"] {
        display: block;
        margin: 0 auto 12px auto;
        font-size: 0.9rem;
      }
      .upload-zone .hint {
        color: #64748b;
        font-size: 0.875rem;
        margin-top: 8px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 20px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        font-weight: 500;
      }
      button:hover:not(:disabled) { background: #1d4ed8; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      button.secondary {
        background: #e2e8f0;
        color: #475569;
      }
      button.secondary:hover:not(:disabled) { background: #cbd5e1; }
      .progress {
        height: 8px;
        background: #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 16px;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #3b82f6, #22c55e);
        transition: width 0.25s ease;
      }
      .error { color: #dc2626; margin-top: 12px; font-size: 0.9rem; }
      .tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .tabs button {
        padding: 8px 16px;
        background: #f1f5f9;
        color: #475569;
        border-radius: 8px;
        font-size: 0.9rem;
      }
      .tabs button.active {
        background: #2563eb;
        color: white;
      }
      .panel {
        display: none;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        max-height: 70vh;
        overflow: auto;
      }
      .panel.active { display: block; }
      .panel pre, .panel.output-text {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.5;
      }
      table.structure {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      table.structure th, table.structure td {
        border: 1px solid #e2e8f0;
        padding: 10px 12px;
        text-align: left;
        vertical-align: top;
      }
      table.structure th {
        background: #f8fafc;
        font-weight: 600;
        color: #334155;
      }
      table.structure tr:hover td { background: #f8fafc; }
      .pill {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
      }
      .pill.text { background: #dbeafe; color: #1d4ed8; }
      .pill.table { background: #dcfce7; color: #15803d; }
      .pill.image { background: #fef3c7; color: #b45309; }
      .pill.stamp { background: #fecaca; color: #b91c1c; }
      .pill.signature { background: #e9d5ff; color: #6b21a8; }
      .pill.unknown { background: #f1f5f9; color: #64748b; }
      .meta { color: #64748b; font-size: 0.875rem; margin-top: 12px; }
      #results { margin-top: 24px; }

      /* Страницы с bbox разметкой */
      .pages-section { margin-top: 24px; }
      .pages-section h3 { margin: 0 0 16px 0; color: #334155; }
      .page-cards {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      .page-card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
      }
      .page-card h4 {
        margin: 0;
        padding: 12px 16px;
        background: #f8fafc;
        font-size: 1rem;
        color: #475569;
      }
      .page-wrapper {
        position: relative;
        display: inline-block;
        max-width: 100%;
        margin: 16px;
        line-height: 0;
        transform-origin: center center;
      }
      .page-wrapper img {
        display: block;
        width: 100%;
        height: auto;
        vertical-align: middle;
      }
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 8px 16px 12px;
        font-size: 0.8rem;
        color: #64748b;
      }
      .legend span { display: inline-flex; align-items: center; gap: 6px; }
      .legend i { width: 14px; height: 14px; border: 2px solid; border-radius: 2px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Qwen Bbox OCR</h1>
      <p class="subtitle">Загрузите PDF — конвертация в изображения и распознавание через vLLM (Qwen-VL): текст, таблицы, изображения, печати, подписи. Ниже — разметка bbox по страницам.</p>

      <div class="card">
        <div class="upload-zone" id="uploadZone">
          <input type="file" id="fileInput" accept=".pdf,application/pdf" />
          <p class="hint">Только PDF. Убедитесь, что сервер vLLM с моделью Qwen-VL запущен (см. .env).</p>
          <div class="row" style="margin-top: 16px; justify-content: center;">
            <button id="processBtn">Распознать</button>
          </div>
        </div>
        <div class="progress" aria-label="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="error" id="error"></div>
      </div>

      <div id="results" style="display: none;">
        <div class="card">
          <div class="tabs">
            <button type="button" data-tab="pages" class="active">Страницы с bbox</button>
            <button type="button" data-tab="structure">Структура (JSON)</button>
            <button type="button" data-tab="markdown">Markdown</button>
          </div>
          <div id="pagesPanel" class="panel active" data-tab="pages">
            <div class="pages-section">
              <h3>Сегментация документа по страницам</h3>
              <div class="legend">
                <span><i style="border-color: #2563eb; background: rgba(37,99,235,0.15);"></i> текст</span>
                <span><i style="border-color: #16a34a; background: rgba(22,163,74,0.15);"></i> таблица</span>
                <span><i style="border-color: #b45309; background: rgba(245,158,11,0.15);"></i> изображение</span>
                <span><i style="border-color: #b91c1c; background: rgba(185,28,28,0.15);"></i> печать</span>
                <span><i style="border-color: #6b21a8; background: rgba(107,33,168,0.15);"></i> подпись</span>
              </div>
              <div class="page-cards" id="pageCards"></div>
            </div>
          </div>
          <div id="structurePanel" class="panel" data-tab="structure">
            <table class="structure" id="structureTable">
            <thead>
                <tr>
                  <th>Страница</th>
                  <th>Тип</th>
                  <th>BBox (пиксели)</th>
                  <th>Текст (фрагмент)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <p class="meta" id="structureMeta"></p>
          </div>
          <div id="markdownPanel" class="panel output-text" data-tab="markdown"></div>
          <p class="meta" id="meta"></p>
        </div>
      </div>
    </div>

    <script>
      const uploadZone = document.getElementById("uploadZone");
      const fileInput = document.getElementById("fileInput");
      const processBtn = document.getElementById("processBtn");
      const progressBar = document.getElementById("progressBar");
      const errorBox = document.getElementById("error");
      const results = document.getElementById("results");
      const pageCards = document.getElementById("pageCards");
      const structurePanel = document.getElementById("structurePanel");
      const markdownPanel = document.getElementById("markdownPanel");
      const structureTableBody = document.querySelector("#structureTable tbody");
      const structureMeta = document.getElementById("structureMeta");
      const metaEl = document.getElementById("meta");

      const COLORS = {
        text:      { stroke: "#2563eb", fill: "rgba(37,99,235,0.12)" },
        table:     { stroke: "#16a34a", fill: "rgba(22,163,74,0.12)" },
        image:     { stroke: "#b45309", fill: "rgba(245,158,11,0.12)" },
        stamp:     { stroke: "#b91c1c", fill: "rgba(185,28,28,0.12)" },
        signature: { stroke: "#6b21a8", fill: "rgba(107,33,168,0.12)" },
      };

      let fakeProgressTimer = null;

      function resetUI() {
        errorBox.textContent = "";
        progressBar.style.width = "0%";
        if (fakeProgressTimer) clearInterval(fakeProgressTimer);
        fakeProgressTimer = null;
      }

      function setUploadState(hasFile) {
        uploadZone.classList.toggle("has-file", !!hasFile);
      }

      fileInput.addEventListener("change", () => setUploadState(!!fileInput.files.length));
      uploadZone.addEventListener("dragover", (e) => { e.preventDefault(); uploadZone.classList.add("dragover"); });
      uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
      uploadZone.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadZone.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          setUploadState(true);
        }
      });

      function startFakeProgress() {
        let progress = 5;
        progressBar.style.width = progress + "%";
        fakeProgressTimer = setInterval(() => {
          progress = Math.min(progress + Math.random() * 8, 88);
          progressBar.style.width = progress + "%";
        }, 500);
      }

      function finishProgress() {
        if (fakeProgressTimer) clearInterval(fakeProgressTimer);
        progressBar.style.width = "100%";
      }

      function pillClass(type) {
        const t = (type || "").toLowerCase();
        if (t === "table") return "table";
        if (t === "image") return "image";
        if (t === "stamp") return "stamp";
        if (t === "signature") return "signature";
        return "text";
      }

      function showTab(tabName) {
        document.querySelectorAll(".tabs button").forEach((b) => {
          b.classList.toggle("active", b.dataset.tab === tabName);
        });
        document.querySelectorAll(".panel").forEach((el) => {
          el.classList.toggle("active", el.dataset.tab === tabName);
        });
      }

      document.querySelectorAll(".tabs button").forEach((b) => {
        b.addEventListener("click", () => showTab(b.dataset.tab));
      });

      function renderPages(pages) {
        pageCards.innerHTML = "";
        (pages || []).forEach((p) => {
          const card = document.createElement("div");
          card.className = "page-card";
          const title = document.createElement("h4");
          const rot = Number(p.rotation_degrees) || 0;
          title.textContent = "Страница " + (p.page || 0) + (rot !== 0 ? " (поворот: " + rot + "°)" : "");
          card.appendChild(title);
          const img = new Image();
          img.src = "data:image/png;base64," + (p.image_base64 || "");
          const wrapper = document.createElement("div");
          wrapper.className = "page-wrapper";
          wrapper.appendChild(img);
          card.appendChild(wrapper);
          pageCards.appendChild(card);
        });
      }

      processBtn.addEventListener("click", async () => {
        resetUI();
        results.style.display = "none";

        const file = fileInput.files[0];
        if (!file) {
          errorBox.textContent = "Выберите или перетащите PDF.";
          return;
        }

        processBtn.disabled = true;
        setUploadState(true);
        startFakeProgress();

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/parse", { method: "POST", body: formData });
          const data = await response.json().catch(() => ({}));
          finishProgress();

          if (!response.ok) throw new Error(data.error || "Ошибка обработки");

          results.style.display = "block";
          showTab("pages");

          const pages = data.pages || [];
          const numPages = data.num_pages || pages.length;
          metaEl.textContent = "Страниц: " + numPages + ". Элементов структуры: " + (data.structure || []).length + ".";

          renderPages(pages);

          markdownPanel.textContent = data.markdown || "";

          const items = data.structure || [];
          structureTableBody.innerHTML = "";
          structureMeta.textContent = items.length ? "Элементов: " + items.length + "." : "Нет элементов.";
          items.forEach((obj) => {
            const row = document.createElement("tr");
            const pageCell = document.createElement("td");
            const typeCell = document.createElement("td");
            const bboxCell = document.createElement("td");
            const textCell = document.createElement("td");
            pageCell.textContent = (obj.page ?? "—").toString();
            typeCell.innerHTML = '<span class="pill ' + pillClass(obj.type) + '">' + (obj.type || "—") + "</span>";
            if (Array.isArray(obj.bbox) && obj.bbox.length >= 4) {
              bboxCell.textContent = obj.bbox.map((x) => Number(x).toFixed(1)).join(", ");
            } else {
              bboxCell.textContent = obj.bbox ? JSON.stringify(obj.bbox) : "—";
            }
            textCell.textContent = (obj.text || "").slice(0, 300);
            if ((obj.text || "").length > 300) textCell.textContent += "…";
            row.appendChild(pageCell);
            row.appendChild(typeCell);
            row.appendChild(bboxCell);
            row.appendChild(textCell);
            structureTableBody.appendChild(row);
          });
        } catch (err) {
          finishProgress();
          errorBox.textContent = err?.message || String(err);
        } finally {
          processBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
